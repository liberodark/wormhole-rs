name: Rust

on:
  push:
    branches: [ "*" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "*" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Install Rust
        run: |
          rustup update 1.91.1
          rustup default 1.91.1
          rustup component add rustfmt clippy
      - name: Check formatting
        run: cargo fmt --all -- --check
      - name: Check Rust and Clippy versions
        run: |
          rustc --version
          cargo clippy --version
          cargo --version
      - name: Run clippy
        run: cargo clippy -- -D warnings

  test:
    name: Test
    needs: check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [stable, beta]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Install Rust
        run: |
          rustup update ${{ matrix.rust }}
          rustup default ${{ matrix.rust }}
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose

  build:
    name: Build ${{ matrix.name }}
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
            ext: ""
            name: linux-x86_64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
            ext: ""
            name: linux-aarch64
          - target: riscv64gc-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
            ext: ""
            name: linux-riscv64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            cross: false
            ext: ".exe"
            name: windows-x86_64
          - target: x86_64-apple-darwin
            os: macos-latest
            cross: false
            ext: ""
            name: darwin-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false
            ext: ""
            name: darwin-aarch64
    steps:
      - uses: actions/checkout@v6
      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Install Rust
        run: |
          rustup update stable
          rustup default stable
          rustup target add ${{ matrix.target }}
      - name: Install cross
        if: matrix.cross
        run: cargo install cross --locked || true
      - name: Build release (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}
      - name: Build release (native)
        if: ${{ !matrix.cross }}
        run: cargo build --release --target ${{ matrix.target }}
      - name: Set version
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
      - name: Create tarball (Unix)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../wormhole-rs-${{ env.VERSION }}-${{ matrix.name }}.tar.gz wormhole-rs
      - name: Create zip (Windows)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "target/${{ matrix.target }}/release/wormhole-rs${{ matrix.ext }}" -DestinationPath "wormhole-rs-${{ env.VERSION }}-${{ matrix.name }}.zip"
      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: wormhole-rs-${{ matrix.name }}
          path: target/${{ matrix.target }}/release/wormhole-rs${{ matrix.ext }}
      - name: Upload tarball artifact
        if: startsWith(github.ref, 'refs/tags/v') && runner.os != 'Windows'
        uses: actions/upload-artifact@v6
        with:
          name: wormhole-rs-${{ matrix.name }}-tarball
          path: wormhole-rs-${{ env.VERSION }}-${{ matrix.name }}.tar.gz
      - name: Upload zip artifact
        if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Windows'
        uses: actions/upload-artifact@v6
        with:
          name: wormhole-rs-${{ matrix.name }}-zip
          path: wormhole-rs-${{ env.VERSION }}-${{ matrix.name }}.zip

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - name: Get version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/
      - name: Prepare release files
        run: |
          mkdir -p release
          # Binaries
          cp artifacts/wormhole-rs-linux-x86_64/wormhole-rs release/wormhole-rs-${{ env.VERSION }}-linux-x86_64
          cp artifacts/wormhole-rs-linux-aarch64/wormhole-rs release/wormhole-rs-${{ env.VERSION }}-linux-aarch64
          cp artifacts/wormhole-rs-linux-riscv64/wormhole-rs release/wormhole-rs-${{ env.VERSION }}-linux-riscv64
          cp artifacts/wormhole-rs-windows-x86_64/wormhole-rs.exe release/wormhole-rs-${{ env.VERSION }}-windows-x86_64.exe
          cp artifacts/wormhole-rs-darwin-x86_64/wormhole-rs release/wormhole-rs-${{ env.VERSION }}-darwin-x86_64
          cp artifacts/wormhole-rs-darwin-aarch64/wormhole-rs release/wormhole-rs-${{ env.VERSION }}-darwin-aarch64
          # Archives
          cp artifacts/wormhole-rs-linux-x86_64-tarball/*.tar.gz release/ || true
          cp artifacts/wormhole-rs-linux-aarch64-tarball/*.tar.gz release/ || true
          cp artifacts/wormhole-rs-linux-riscv64-tarball/*.tar.gz release/ || true
          cp artifacts/wormhole-rs-windows-x86_64-zip/*.zip release/ || true
          cp artifacts/wormhole-rs-darwin-x86_64-tarball/*.tar.gz release/ || true
          cp artifacts/wormhole-rs-darwin-aarch64-tarball/*.tar.gz release/ || true
          chmod +x release/wormhole-rs-*-linux-* release/wormhole-rs-*-darwin-*
      - name: Extract changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(awk "/^## \[${{ env.VERSION }}\]/ {flag=1;next} /^## \[/ {flag=0} flag" CHANGELOG.md | tr -d '\r')
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="Release version ${{ env.VERSION }}"
            fi
            echo "CHANGELOG<<EOF" >> $GITHUB_ENV
            echo "$CHANGELOG" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "CHANGELOG=Release version ${{ env.VERSION }}" >> $GITHUB_ENV
          fi
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body: ${{ env.CHANGELOG }}
          draft: false
          prerelease: false
